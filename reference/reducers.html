<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>Clojure - Reducer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clojure の日本語ドキュメントです">
    <meta name="author" content="Japan Clojurians">
    <meta name="keywords" content="Clojure 日本語">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/normalize.css" rel="stylesheet">
    <link href="../css/webflow.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" type="image/x-icon" href="../images/clojure-logo-icon-32.png">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Clojure</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="../about/rationale.html">概要</a></li>
            <li><a href="../reference/documentation">リファレンス</a></li>
            <!-- <li><a href="../api/api.html">API</a></li>
              <li><a href="../community/downloads.html">リリース</a></li>
              <li><a href="../guides/guides.html">ガイド</a></li>
              <li><a href="../community/resources.html">コミュニティ</a></li>
              <li><a href="../news/news.html">ニュース</a></li>
              <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
              <li><a href="#">Action</a></li>
              <li><a href="#">Another action</a></li>
              <li><a href="#">Something else here</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Nav header</li>
              <li><a href="#">Separated link</a></li>
              <li><a href="#">One more separated link</a></li>
              </ul>
              </li> -->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">

<div class="page-header">
  <h1>Reducer</h1>
</div>

<p><em></em></p>

<p><div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_reduce_と_fold">reduce と fold</a></li>
<li><a href="#_reducerを使用する">Reducerを使用する</a></li>
<li><a href="#_使用するべき時">使用するべき時</a></li>
</ul>
</div>
<div class="paragraph">
<p>Reducerは <a href="sequences">sequences</a>
を使用した操作とは異なるアプローチで、標準的なClojureのコレクションに対する操作を提供する。Sequence関数は一般的に単一のスレッドで、逐次的に中間の結果を作りながら遅延評価される。しかし、多くのSequence関数は概念的には並列に適用することが可能で、マシンのコア数に比例したコードの速度を実現出来る。Reducerの背景についての詳細は元の
<a href="http://clojure.com/blog/2012/05/08/reducers-a-library-and-model-for-collection-processing.html">blog</a>
<a href="http://clojure.com/blog/2012/05/15/anatomy-of-reducer.html">posts</a> を参照。</p>
</div>
<div class="paragraph">
<p><em>reducer</em> とは   <em>畳み込み可能なコレクション</em> (自分自身の畳み込み方を知っているコレクション) と <em>畳み込み関数</em>
(畳み込みの際に必要な処理の "レシピ")
の組み合せである。標準的なSequence操作は、実際の操作を行わない代わりに畳込み関数を変換するもので置き換えられる。操作の実行は最終的な畳込みが行われるまで保留される。これによってsequenceにあるような中間結果や遅延評価を取り除くことが出来る。</p>
</div>
<div class="paragraph">
<p>加えていくつかのコレクションは (persistent な ベクター や マップ) は <em>フォールド可能</em> である。Reducerに対する
<em>フォールド</em> 操作は畳み込みを次のように並列に実行する:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>畳み込み可能なコレクションを指定されたサイズに分割する (デフォルト = 512 要素)</p>
</li>
<li>
<p>各分割に対して reduce を適用する</p>
</li>
<li>
<p>再帰的に各分割を Javaの <a href="http://gee.cs.oswego.edu/dl/papers/fj.pdf">fork/join</a>
フレームワークを使用して結合する。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>コレクションがフォールドをサポートしていない場合は非並列なreduceにフォールバックする。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reduce_と_fold">reduce と fold</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>clojure.core.reducers</strong> のネームスペースでは (ここでは <strong>r</strong> としてエイリアスしている)
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/reduce">r/reduce</a>
関数の代わりを提供している。</p>
</div>
<div class="paragraph">
<p><strong>(r/reduce f coll)</strong><br>
<strong>(r/reduce f init coll)</strong></p>
</div>
<div class="paragraph">
<p>reducer のバージョンは次の点で異なる:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>マップのコレクションは reduce-kv でreduceされる</p>
</li>
<li>
<p>* init が与えられていない場合、 初期値を作り出すために f が引数なしで呼び出される。</p>
<div class="ulist">
<ul>
<li>
<p><em>注: 初期値を作り出すために f が複数呼び出される場合がある。</em></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>一般的にはほとんどのユーザーは、 r/reduce を直接呼び出す代わりに、並列なreduceと結合を実装する
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/fold">r/fold</a>
を使用するべきである。ただし、中間結果を削減する目的で貪欲なreduceを実行することは有用かもしれない。</p>
</div>
<div class="paragraph">
<p><strong>(r/fold reducef coll)</strong><br>
<strong>(r/fold combinef reducef coll)</strong><br>
<strong>(r/fold n combinef reducef coll)</strong>*</p>
</div>
<div class="paragraph">
<p>r/fold はreduce可能なコレクションを受け取り、それを要素数がほぼ n (デフォルト
512)のグループに分割する。各グループはreducef関数でreduceされる。reducef関数は <em>各分割で</em>
初期値を作り出すため引数無しで呼び出される。それぞれのreduceの結果がさらにcombinef関数でreduceされる(defaultがreducef)。引数無しで.呼び出される場合にcombinef関数はその恒等値を作りだす必要がある
- これは複数回呼び出される。操作は並列に実行されうる。結果は順序を保持する。</p>
</div>
<div class="paragraph">
<p>以下の関数は (sequence版と同様に) reducerをreduce、fold可能なコレクションを作成する:
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/map">r/map</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/mapcat">r/mapcat</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/filter">r/filter</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/remove">r/remove</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/flatten">r/flatten</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/take-while">r/take-while</a>
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/take">r/take</a>
及び
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/drop">r/drop</a>
。 これらの関数は実際には元のコレクションを変換しない。積算した結果を得るには r/reduce か r/fold を使用する。出力を得るには
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/into">clojure.core/into</a>
を使用してコレクションのタイプを選択するか、提供されている
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/foldcat">r/foldcat</a>
を使用してreduce可能,fold可能,seq可能、count可能なコレクションを得る。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reducerを使用する">Reducerを使用する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>fold を使用して + で和を求める:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(require '[clojure.core.reducers :as r])
(r/fold + (r/filter even? (r/map inc [1 1 1 2])))
;=&gt; 6</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/into">into</a>
を使用して最終的なコレクションを作成する:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(into [] (r/filter even? (r/map inc (range 100000))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>もしくは
<a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core.reducers/foldcat">r/foldcat</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(r/foldcat (r/filter even? (r/map inc (range 100000))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>foldのreduce関数とcombine関数を指定する:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(defn count-words
  ([] {})
  ([freqs word]
    (assoc freqs word (inc (get freqs word 0)))))

(defn merge-counts
  ([] {})
  ([&amp; m] (apply merge-with + m)))

(defn word-frequency [text]
  (r/fold merge-counts count-words (clojure.string/split text #"\s+")))</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用するべき時">使用するべき時</h2>
<div class="sectionbody">
<div class="paragraph">
<p>reducer formを使用するべき操作:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>効率の良い、積極的な複数ステップの変換の適用</p>
</li>
<li>
<p>遅延シーケンスに見られるような、取り残されたI/Oリソースの問題を避ける</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>fold</code> を使用するべき時:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ソースのデータが、メモリ内で生成出来、かつ保持出来る</p>
</li>
<li>
<p>処理の内容が計算である (I/O や ブロッキングではない)</p>
</li>
<li>
<p>処理件数や行う処理が "大きい" 場合</p>
</li>
</ul>
</div>
</div>
</div></p>

<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>

  </body>
</html>