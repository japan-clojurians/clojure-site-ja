<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8"/>
    <title>Clojure - Datatypes: deftype, defrecord and reify</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clojure の日本語ドキュメントです">
    <meta name="author" content="Japan Clojurians">
    <meta name="keywords" content="Clojure 日本語">
    <meta name="generator" content="JBake">

    <!-- Le styles -->
    <link href="../css/normalize.css" rel="stylesheet">
    <link href="../css/webflow.css" rel="stylesheet">
    <link href="../css/asciidoctor.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/prettify.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">-->
    <link rel="shortcut icon" type="image/x-icon" href="../images/clojure-logo-icon-32.png">
  </head>
  <body onload="prettyPrint()">
    <div id="wrap">

	<!-- Fixed navbar -->
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../">Clojure</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
              <!-- <li><a href="../about/rationale.html">概要</a></li> -->
            <li><a href="../reference/documentation">リファレンス</a></li>
            <!-- <li><a href="../api/api.html">API</a></li>
              <li><a href="../community/downloads.html">リリース</a></li>
              <li><a href="../guides/guides.html">ガイド</a></li>
              <li><a href="../community/resources.html">コミュニティ</a></li>
              <li><a href="../news/news.html">ニュース</a></li>
              <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
              <ul class="dropdown-menu">
              <li><a href="#">Action</a></li>
              <li><a href="#">Another action</a></li>
              <li><a href="#">Something else here</a></li>
              <li class="divider"></li>
              <li class="dropdown-header">Nav header</li>
              <li><a href="#">Separated link</a></li>
              <li><a href="#">One more separated link</a></li>
              </ul>
              </li> -->
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>
    <div class="container">

<div class="page-header">
  <h1>Datatypes: deftype, defrecord and reify</h1>
</div>

<p><em></em></p>

<p><div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_motivation">Motivation</a></li>
<li><a href="#_basics">Basics</a></li>
<li><a href="#_deftype_and_defrecord">deftype and defrecord</a></li>
<li><a href="#_why_have_both_deftype_and_defrecord">Why have both deftype and defrecord?</a></li>
<li><a href="#_datatypes_and_protocols_are_opinionated">Datatypes and protocols are opinionated</a></li>
<li><a href="#_reify">reify</a></li>
<li><a href="#_java_annotation_support">Java annotation support</a></li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_motivation">Motivation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clojure is written in terms of abstractions. There are abstractions for sequences, collections, callability, etc. In addition, Clojure supplies many implementations of these abstractions. The abstractions are specified by host interfaces, and the implementations by host classes. While this was sufficient for bootstrapping the language, it left Clojure without similar abstraction and low-level implementation facilities. The <a href="protocols">protocols</a> and <a href="datatypes">datatypes</a> features add powerful and flexible mechanisms for abstraction and data structure definition with no compromises vs the facilities of the host platform.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basics">Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The datatype features - <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/deftype">deftype</a> , <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/defrecord">defrecord</a> and <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/reify">reify</a> , provide the mechanism for defining implementations of abstractions, and in the case of reify, instances of those implementations. The abstractions themselves are defined by either <a href="protocols">protocols</a> or interfaces. A datatype provides a host type, (named in the case of deftype and defrecord, anonymous in the case of reify), with some structure (explicit fields in the case of deftype and defrecord, implicit closure in the case of reify), and optional in-type implementations of abstraction methods. They support, in a relatively clean manner, access to the highest-performance primitive representation and polymorphism mechanisms of the host. N.B. that they are not merely host-in-parens constructs. They support only a circumscribed subset of the host facilities, often with more dynamism than the host itself. The intent is that, unless interop forces one to go beyond their circumscribed scope, one need not leave Clojure to get the highest-performing data structures possible on the platform.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deftype_and_defrecord">deftype and defrecord</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/deftype">deftype</a> and <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/defrecord">defrecord</a> dynamically generate compiled bytecode for a named class with a set of given fields, and, optionally, methods for one or more protocols and/or interfaces. They are suitable for dynamic and interactive development, need not be AOT compiled, and can be re-evaluated in the course of a single session. They are similar to defstruct in generating data structures with named fields, but differ from defstruct in that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They generate a unique class, with fields corresponding to the given names.</p>
</li>
<li>
<p>the resulting class has a proper type, unlike conventions for encoding type for structs in metadata</p>
</li>
<li>
<p>because they generate a named class, it has an accessible constructor</p>
</li>
<li>
<p>fields can have type hints, and can be primitive</p>
<div class="ulist">
<ul>
<li>
<p>note that currently a type hint of a non-primitive type will not be used to constrain the field type nor the constructor arg, but will be used to optimize its use in the class methods</p>
</li>
<li>
<p>constraining the field type and constructor arg is planned</p>
</li>
</ul>
</div>
</li>
<li>
<p>a deftype/defrecord can implement one or more protocols and/or interfaces</p>
</li>
<li>
<p>deftype/defrecord can be written with a special reader syntax #my.thing[1 2 3] where:</p>
<div class="ulist">
<ul>
<li>
<p>each element in the vector form is passed to the deftype/defrecord&#8217;s constructor un-evaluated</p>
</li>
<li>
<p>the deftype/defrecord name must be fully qualified</p>
</li>
<li>
<p>only available in Clojure versions later than 1.3</p>
</li>
</ul>
</div>
</li>
<li>
<p>when a deftype/defrecord Foo is defined a corresponding function <code>->Foo</code> is defined that passes its arguments to the constructor (versions 1.3 and later only)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/deftype">deftype</a> and <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/defrecord">defrecord</a> differ in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>deftype provides no functionality not specified by the user, other than a constructor</p>
</li>
<li>
<p>defrecord provides a complete implementation of a persistent map, including:</p>
<div class="ulist">
<ul>
<li>
<p>value-based equality and hashCode</p>
</li>
<li>
<p>metadata support</p>
</li>
<li>
<p>associative support</p>
</li>
<li>
<p>keyword accessors for fields</p>
</li>
<li>
<p>extensible fields (you can assoc keys not supplied with the defrecord definition)</p>
</li>
<li>
<p>etc</p>
</li>
</ul>
</div>
</li>
<li>
<p>deftype supports mutable fields, defrecord does not</p>
</li>
<li>
<p>defrecord support an additional reader form of #my.record{:a 1, :b 2} taking a map that initializes a defrecord according to:</p>
<div class="ulist">
<ul>
<li>
<p>the defrecord name must be fully qualified</p>
</li>
<li>
<p>the elements in the map are un-evaluated</p>
</li>
<li>
<p>existing defrecord fields take the keyed values</p>
</li>
<li>
<p>defrecord fields without keyed values in the literal map are initialized to nil</p>
</li>
<li>
<p>additional keyed values are allowed and added to the defrecord</p>
</li>
<li>
<p>only available in Clojure versions later than 1.3</p>
</li>
</ul>
</div>
</li>
<li>
<p>when a defrecord Bar is defined a corresponding function <code>map->Bar</code> is defined that takes a map and initializes a new record instance with its contents (versions 1.3 and later only)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_have_both_deftype_and_defrecord">Why have both deftype and defrecord?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It ends up that classes in most OO programs fall into two distinct categories: those classes that are artifacts of the implementation/programming domain, e.g. String or collection classes, or Clojure&#8217;s reference types; and classes that represent application domain information, e.g. Employee, PurchaseOrder etc. It has always been an unfortunate characteristic of using classes for application domain information that it resulted in information being hidden behind class-specific micro-languages, e.g. even the seemingly harmless employee.getName() is a custom interface to data. Putting information in such classes is a problem, much like having every book being written in a different language would be a problem. You can no longer take a generic approach to information processing. This results in an explosion of needless specificity, and a dearth of reuse.</p>
</div>
<div class="paragraph">
<p>This is why Clojure has always encouraged putting such information in maps, and that advice doesn&#8217;t change with datatypes. By using defrecord you get generically manipulable information, plus the added benefits of type-driven polymorphism, and the structural efficiencies of fields. OTOH, it makes no sense for a datatype that defines a collection like vector to have a default implementation of map, thus deftype is suitable for defining such programming constructs.</p>
</div>
<div class="paragraph">
<p>Overall, records will be better than structmaps for all information-bearing purposes, and you should move such structmaps to defrecord. It is unlikely much code was trying to use structmaps for programming constructs, but if so, you will find deftype much more suitable.</p>
</div>
<div class="paragraph">
<p>AOT-compiled deftype/defrecord may be suitable for some of the use cases of <strong>gen-class</strong>, where their limitations are not prohibitive. In those cases, they will have better performance than gen-class.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_datatypes_and_protocols_are_opinionated">Datatypes and protocols are opinionated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While datatypes and protocols have well-defined relationships with host constructs, and make for a great way to expose Clojure functionality to Java programs, they are not primarily interop constructs. That is, they make no effort to completely mimic or adapt to all of the OO mechanisms of the host. In particular, they reflect the following opinions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concrete derivation is bad</p>
<div class="ulist">
<ul>
<li>
<p>you cannot derive datatypes from concrete classes, only interfaces</p>
</li>
</ul>
</div>
</li>
<li>
<p>You should always program to protocols or interfaces</p>
<div class="ulist">
<ul>
<li>
<p>datatypes cannot expose methods not in their protocols or interfaces</p>
</li>
</ul>
</div>
</li>
<li>
<p>Immutability should be the default</p>
<div class="ulist">
<ul>
<li>
<p>and is the only option for records</p>
</li>
</ul>
</div>
</li>
<li>
<p>Encapsulation of information is folly</p>
<div class="ulist">
<ul>
<li>
<p>fields are public, use protocols/interfaces to avoid dependencies</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tying polymorphism to inheritance is bad</p>
<div class="ulist">
<ul>
<li>
<p>protocols free you from that</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you use datatypes and protocols you will have a clean, interface-based API to offer your Java consumers. If you are dealing with a clean, interface-based Java API, datatypes and protocols can be used to interoperate with and extend it. If you have a 'bad' Java API, you will have to use gen-class. Only in this way can the programming constructs you use to design and implement your Clojure programs be free of the incidental complexities of OO.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reify">reify</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While deftype and defrecord define named types, <a href="https://clojure.github.io/clojure/clojure.core-api.html#clojure.core/reify">reify</a> defines both an anonymous type and creates an instance of that type. The use case is where you need a one-off implementation of one or more protocols or interfaces and would like to take advantage of the local context. In this respect it is use case similar to proxy, or anonymous inner classes in Java.</p>
</div>
<div class="paragraph">
<p>The method bodies of reify are lexical closures, and can refer to the surrounding local scope. <strong>reify</strong> differs from <strong>proxy</strong> in that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only protocols or interfaces are supported, no concrete superclass.</p>
</li>
<li>
<p>The method bodies are true methods of the resulting class, not external fns.</p>
</li>
<li>
<p>Invocation of methods on the instance is direct, not using map lookup.</p>
</li>
<li>
<p>No support for dynamic swapping of methods in the method map.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The result is better performance than proxy, both in construction and invocation. <strong>reify</strong> is preferable to proxy in all cases where its constraints are not prohibitive.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_java_annotation_support">Java annotation support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Types created with deftype, defrecord, and definterface, can emit classes that include Java annotations for Java interop. Annotations are described as meta on:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Type name (deftype/record/interface) - class annotations</p>
</li>
<li>
<p>Field names (deftype/record) - field annotations</p>
</li>
<li>
<p>Method names (deftype/record) - method annotations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-clojure" data-lang="clojure">(import [java.lang.annotation Retention RetentionPolicy Target ElementType]
        [javax.xml.ws WebServiceRef WebServiceRefs])

(definterface Foo (foo []))

;; annotation on type
(deftype ^{Deprecated true
           Retention RetentionPolicy/RUNTIME
           javax.annotation.processing.SupportedOptions ["foo" "bar" "baz"]
           javax.xml.ws.soap.Addressing {:enabled false :required true}
           WebServiceRefs [(WebServiceRef {:name "fred" :type String})
                           (WebServiceRef {:name "ethel" :mappedName "lucy"})]}
  Bar [^int a
       ;; on field
       ^{:tag int
         Deprecated true
         Retention RetentionPolicy/RUNTIME
         javax.annotation.processing.SupportedOptions ["foo" "bar" "baz"]
         javax.xml.ws.soap.Addressing {:enabled false :required true}
         WebServiceRefs [(WebServiceRef {:name "fred" :type String})
                         (WebServiceRef {:name "ethel" :mappedName "lucy"})]}
       b]
  ;; on method
  Foo (^{Deprecated true
         Retention RetentionPolicy/RUNTIME
         javax.annotation.processing.SupportedOptions ["foo" "bar" "baz"]
         javax.xml.ws.soap.Addressing {:enabled false :required true}
         WebServiceRefs [(WebServiceRef {:name "fred" :type String})
                         (WebServiceRef {:name "ethel" :mappedName "lucy"})]}
       foo [this] 42))

(seq (.getAnnotations Bar))
(seq (.getAnnotations (.getField Bar "b")))
(seq (.getAnnotations (.getMethod Bar "foo" nil)))</code></pre>
</div>
</div>
</div>
</div></p>

<hr />

		</div>
		<div id="push"></div>
    </div>

    <div id="footer">
      <div class="container">
      </div>
    </div>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="../js/jquery-1.11.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/prettify.js"></script>

  </body>
</html>